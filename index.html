<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>永續報告書自動評分系統 (專業評分版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #1A3D63;
            --primary-blue-dark: #0A1931;
            --primary-accent: #4A7FA7;
            --light-bg: #F6FAFD;
            --border-color: #B3CFE5;
            --text-primary: #0A1931;
            --text-secondary: #4A7FA7;
        }
        body { 
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; 
            background-color: var(--light-bg);
            color: var(--text-primary);
        }
        .step-indicator { 
            transition: all 0.3s ease; 
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }
        .step-line {
            height: 2px;
            background-color: var(--border-color);
            transition: all 0.3s ease;
        }
        .step-active { 
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white; 
            transform: scale(1.1);
            box-shadow: 0 4px 14px 0 rgba(26, 61, 99, 0.25);
        }
        .step-completed { 
            background-color: var(--primary-accent);
            border-color: var(--primary-accent);
            color: white; 
        }
        .step-line-active {
            background-color: var(--primary-blue);
        }
         .step-line-completed {
            background-color: var(--primary-accent);
        }
        .upload-area { 
            border: 2px dashed var(--border-color);
            transition: all 0.3s ease;
            background-color: white;
        }
        .upload-area:hover, .upload-area.dragover { 
            border-color: var(--primary-blue); 
            background-color: #eef6fc; 
        }
        .loader {
            width: 56px; height: 56px; border: 6px solid var(--border-color);
            border-bottom-color: var(--primary-blue); border-radius: 50%; display: inline-block;
            box-sizing: border-box; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details summary { list-style: none; cursor: pointer; }
        details summary::-webkit-details-marker { display: none; }
        .chart-container { position: relative; height: 280px; width: 100%; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: var(--primary-blue);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-blue-dark);
        }
        .btn-secondary {
            background-color: #ffffff;
            color: var(--text-secondary);
            border-color: var(--border-color);
        }
        .btn-secondary:hover {
            background-color: #f8f9fa;
            border-color: #a8c1d5;
        }
        .btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-light-bg">
    
    <div class="container mx-auto px-4 py-12">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-text-primary mb-3">永續報告書 AI 智能評分系統</h1>
            <p class="text-lg text-text-secondary max-w-2xl mx-auto">基於 TCSA 台灣企業永續獎評選準則，提供專業、客觀的 AI 評分與洞察</p>
        </header>

        <div id="steps-container" class="max-w-4xl mx-auto mb-12">
             <div class="flex items-center">
                <div id="step1" class="step-indicator flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg">1</div>
                <div id="step-line-1" class="step-line flex-grow"></div>
                <div id="step2" class="step-indicator flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg">2</div>
                <div id="step-line-2" class="step-line flex-grow"></div>
                <div id="step3" class="step-indicator flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg">3</div>
                <div id="step-line-3" class="step-line flex-grow"></div>
                <div id="step4" class="step-indicator flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg">4</div>
            </div>
            <div class="flex justify-between mt-2 text-sm text-text-secondary">
                <span class="text-center w-1/4">評分架構</span>
                <span class="text-center w-1/4">上傳與配置</span>
                <span class="text-center w-1/4">AI 分析評分</span>
                <span class="text-center w-1/4">查看分析結果</span>
            </div>
        </div>

        <div id="step1-content" class="card p-8">
            <h2 class="text-2xl font-bold text-text-primary mb-6 flex items-center">
                 <svg class="w-6 h-6 mr-3 text-primary-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                TCSA 評選架構說明
            </h2>
            <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-r-lg p-4 mb-6">
                <p>本系統將依據 TCSA 永續報告書獎評選準則，透過 AI 進行分析。評分架構如下：</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 text-text-primary">
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <h3 class="font-bold text-xl mb-4">永續報告書 (60%)</h3>
                    <details class="mb-2" open><summary class="font-semibold text-lg py-1">一、完整性 (40%)</summary><ul class="mt-1 text-sm text-text-secondary space-y-1 pl-5 list-disc"><li>重大性議題 (8%)</li><li>利害關係人共融 (6%)</li><li>策略 (12%)</li><li>組織介紹 (2%)</li><li>重大永續規範執行及資訊揭露 (12%)</li></ul></details>
                    <details class="mb-2" open><summary class="font-semibold text-lg py-1">二、可信度 (35%)</summary><ul class="mt-1 text-sm text-text-secondary space-y-1 pl-5 list-disc"><li>管理流程 (10%)</li><li>利害關係人回應 (5%)</li><li>治理 (5%)</li><li>績效 (5%)</li><li>保證/確信 (10%)</li></ul></details>
                    <details open><summary class="font-semibold text-lg py-1">三、溝通性 (25%)</summary><ul class="mt-1 text-sm text-text-secondary space-y-1 pl-5 list-disc"><li>展現 (10%)</li><li>利害關係人共融 (5%)</li><li>架構 (10%)</li></ul></details>
                </div>
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                     <h3 class="font-bold text-xl mb-4">多元媒體應用 (40%)</h3>
                     <ul class="mt-2 text-base text-text-secondary space-y-2 pl-5 list-disc">
                        <li>組織永續專區完整性 (20%)</li><li>網頁管理與即時更新 (15%)</li>
                        <li>電子版報告書與關鍵資訊連結 (20%)</li><li>多元媒體展現 (25%)</li>
                        <li>溝通回饋管道與社群網絡互動 (20%)</li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4">
                 <button type="button" id="test-connection-btn" class="btn btn-secondary w-full sm:w-auto">
                    <svg id="test-icon-svg" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span id="test-text">測試後端連接</span>
                </button>
                <button type="button" id="next-step1" class="btn btn-primary w-full sm:w-auto">
                    下一步：上傳報告書
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
             <div id="connection-status" class="hidden mt-4 text-sm"></div>
        </div>
        
        <div id="step2-content" class="card p-8 hidden">
            <h2 class="text-2xl font-bold text-text-primary mb-6">上傳報告書與網站連結</h2>
            <div id="upload-area" class="upload-area p-6 rounded-lg text-center cursor-pointer mb-6">
                <div class="flex flex-col items-center justify-center space-y-3 text-text-secondary">
                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h2a4 4 0 014 4v1m-1 8l-4-4m0 0l-4 4m4-4v12"></path></svg>
                    <p class="font-semibold">拖放 PDF 到此，或<span class="text-primary-blue">點擊選擇檔案</span></p>
                    <p class="text-xs">支援多檔案上傳</p>
                </div>
            </div>
            <input type="file" id="report-files" accept=".pdf" multiple class="hidden">
            <div id="uploaded-reports" class="mb-6 space-y-3"></div>
            
            <div class="border-t border-slate-200 pt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-text-primary">企業網站連結</h3>
                    <button onclick="addWebsiteLink()" class="btn bg-primary-accent hover:bg-primary-accent-dark text-white text-sm px-4 py-2">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        新增網站
                    </button>
                </div>
                <div id="website-links-container" class="space-y-3">
                    <div class="flex gap-3 items-center website-link-item">
                        <input type="text" placeholder="公司名稱 (需與 PDF 檔名對應)" class="company-name w-1/3 border border-slate-300 px-3 py-2 rounded-md focus:ring-2 focus:ring-primary-blue focus:border-primary-blue" />
                        <input type="url" placeholder="https://www.example.com" class="website-url flex-1 border border-slate-300 px-3 py-2 rounded-md focus:ring-2 focus:ring-primary-blue focus:border-primary-blue" />
                        <button onclick="removeWebsiteLink(this)" class="text-slate-400 hover:text-red-500 p-2 rounded-md transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex items-center border-t border-slate-200 pt-6">
                <button id="next-step2" class="btn btn-primary" disabled>
                    開始 AI 分析
                </button>
                <span id="step2-validation-msg" class="ml-4 text-sm text-text-secondary">需至少上傳 1 份 PDF 檔案與 1 個對應的網站 URL</span>
            </div>
        </div>

        <div id="step3-content" class="card p-8 text-center hidden">
            <div class="loader mx-auto mb-6"></div>
            <h2 class="text-2xl font-semibold text-text-primary mb-2">AI 分析評分中</h2>
            <p class="text-text-secondary mb-8">正在處理您提交的報告書，這可能需要數分鐘，請稍候...</p>
            <div id="analysis-progress" class="mt-6 max-w-2xl mx-auto text-left text-sm space-y-2 text-text-primary bg-slate-100 p-4 rounded-lg border border-slate-200"></div>
        </div>

        <div id="step4-content" class="hidden">
            <div id="pdf-content" class="space-y-12"></div>
            <div class="mt-12 flex justify-center">
                <button id="restart" class="btn btn-secondary text-base">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5m-4 9a9 9 0 110-18 9 9 0 010 18z"></path></svg>
                    重新開始一次新的評分
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 全域變數與設定 ---
        const BACKEND_URL = 'http://127.0.0.1:8000';
        let allResultsData = [];
        let uploadedFiles = [];

        // 預設 TCSA 評分架構
        const DEFAULT_RUBRIC = {
            report: {
                id: "report", sections: [
                    { title: "完整性", max_score: 40, criteria: [ { title: "重大性議題", max_score: 8, sub_criteria: [ {title: "是否清楚列出或呈現重大性議題分析之矩陣圖或其他圖表，且清楚標明各項議題的種類", max_score: 2}, {title: "是否清楚說明組織重大性議題分析之過程與方法", max_score: 2}, {title: "是否有呈現出重大性議題在報告書中的連結性", max_score: 2}, {title: "是否清楚說明重大性議題對於組織的意義", max_score: 2} ] }, { title: "利害關係人共融", max_score: 6, sub_criteria: [ {title: "是否清楚列出組織的利害關係人之種類與意義", max_score: 1}, {title: "是否清楚說明各種利害關係人議合之方法", max_score: 2}, {title: "是否清楚說明各種利害關係人關注之議題", max_score: 1}, {title: "是否清楚說明組織針對各項議題的因應之道", max_score: 2} ] }, { title: "策略", max_score: 12, sub_criteria: [ {title: "報告書中是否有說明永續對組織的重要性與意義(價值鏈的呈現)", max_score: 2}, {title: "報告書中是否有揭露組織營運相關之內外部環境分析", max_score: 3}, {title: "報告書中是否有揭露組織對於環境、社會、治理等面向的發展原則與管理機制(長期策略)", max_score: 3}, {title: "是否有在各個面向或是各類重大性議題說明組織未來改善目標(中期策略)", max_score: 2}, {title: "針對各項重大性議題是否有設定隔年度之量化或是質化目標(短期策略)", max_score: 2} ] }, { title: "組織介紹", max_score: 2, sub_criteria: [ {title: "揭露資訊：主要產品與服務、財務績效、地理分布、員工資訊、整體環境與組織營運之關聯性等", max_score: 2} ] }, { title: "重大永續規範執行及資訊揭露", max_score: 12, sub_criteria: [ {title: "氣候相關財務揭露(TCFD)", max_score: 3}, {title: "永續會計準則委員會準則(SASB)", max_score: 3}, {title: "自然相關財務揭露(TNFD)", max_score: 3}, {title: "國際財務報導準則(IFRS) S1,S2揭露", max_score: 3} ] } ] },
                    { title: "可信度", max_score: 35, criteria: [ { title: "管理流程", max_score: 10, sub_criteria: [ {title: "報告揭露採用之指引與準則", max_score: 1}, {title: "是否揭露報告書主要負責單位", max_score: 1}, {title: "報告書的管理方式", max_score: 4}, {title: "針對各項重大性議題皆說明管理方針", max_score: 4} ] }, { title: "利害關係人回應", max_score: 5, sub_criteria: [ {title: "針對利害關係人關注之議題，組織是否實際回應議題，並提出相對應之作為、策略與規劃等政策", max_score: 2}, {title: "組織是否有針對組織鑑別出之實質性議題進行回應，並提出相對應之策略與作為", max_score: 3} ] }, { title: "治理", max_score: 5, sub_criteria: [ {title: "是否有說明組織組織針對永續報告的責任單位", max_score: 1}, {title: "報告書是否有說明董事會的薪酬與永續績效的連結性", max_score: 2}, {title: "報告書是否有揭露組織組織的風險與可能之機會(因應之道)", max_score: 1}, {title: "組織績效指標管理方針是否與組織永續原則一致", max_score: 1} ] }, { title: "績效", max_score: 5, sub_criteria: [ {title: "績效之揭露是否完整(重大性議題涵蓋經濟、環境與社會，是否有質化的說明與數據)", max_score: 2}, {title: "重大性議題是否有量化的圖表說明", max_score: 1}, {title: "是否有揭露過去負面訊息", max_score: 1}, {title: "績效的呈現是否易懂", max_score: 1} ] }, { title: "保證/確信", max_score: 10, sub_criteria: [ {title: "是否已建立永續資訊編制內部控制制度及相關流程", max_score: 2}, {title: "永續資訊編制內部控制制度及其內部稽核執行情形說明", max_score: 3}, {title: "是否有外部第三方獨立保證/確信之佐證資料", max_score: 2}, {title: "外部保證是否有說明保證等級、範疇與方法(中度/有限等級者最多得2分，高度/合理等級者做多可得3分)", max_score: 3} ] } ] },
                    { title: "溝通性", max_score: 25, criteria: [ { title: "展現", max_score: 10, sub_criteria: [ {title: "版面是否圖表與文字說明比例恰當，內容清晰且易於閱讀", max_score: 3}, {title: "具有英文版報告書", max_score: 3}, {title: "展現創新的資訊呈現方式", max_score: 2}, {title: "報告書之份量是否適當(頁數120-150頁為參考範圍)", max_score: 2} ] }, { title: "利害關係人共融", max_score: 5, sub_criteria: [ {title: "組織永續報告書是否公開下載", max_score: 1}, {title: "是否有說明利害關係人議合(溝通資訊)的方法", max_score: 2}, {title: "利害關係人議合的結果，組織是否公開揭露其相對應的回應與作為", max_score: 2} ] }, { title: "架構", max_score: 10, sub_criteria: [ {title: "是否清楚整理並呈現本年度の亮點作為報告書的總結", max_score: 3}, {title: "完整的索引設計(包括GRI, SASB及其他重要規範等)", max_score: 3}, {title: "報告書附有清楚的連結，使讀者可透過網頁的說明獲得更細節的資訊", max_score: 2}, {title: "架構呈現完整易於查閱", max_score: 2} ] } ] }
                ]
            },
            media: {
                id: "media", sections: [
                    { title: "多元媒體應用及內容品質", max_score: 19, criteria: [ { title: "組織永續專區", max_score: 3, sub_criteria: [ {title: "設置組織永續專區", max_score: 0.5}, {title: "是否將組織永續專區連結設於首頁", max_score: 0.5}, {title: "是否提供報告書下載", max_score: 0.5}, {title: "是否有網站地圖", max_score: 0.5}, {title: "站內搜尋引擎", max_score: 0.5}, {title: "是否將組織永續專區分類且內容充實", max_score: 0.5} ] }, { title: "網頁管理與即時更新", max_score: 4, sub_criteria: [ {title: "判斷依據：由最新消息觀察網頁是否為最新訊息、是否即時更新", max_score: 4} ] }, { title: "電子版報告書與關鍵資訊連結", max_score: 4, sub_criteria: [ {title: "按照永續報告定義，須符合環境、社會與治理(ESG)以及供應鏈管理等四項議題之揭露", max_score: 4} ] }, { title: "多元媒體展現", max_score: 4, sub_criteria: [ {title: "文字說明", max_score: 1}, {title: "圖表說明", max_score: 1}, {title: "使用影片", max_score: 1}, {title: "互動式網頁", max_score: 1} ] }, { title: "溝通回饋管道與社群網絡互動", max_score: 4, sub_criteria: [ {title: "線上回饋機制之應用(網路填寫或連結至電子信箱)", max_score: 1}, {title: "線上互動式機制之應用", max_score: 1}, {title: "社交網站之應用", max_score: 1}, {title: "提供訂閱電子報", max_score: 1} ] } ] }
                ]
            }
        };

        // --- ⭐ PDF 產生方案 (動態載入外部 TTF 字體) ---
        const FONT_URL = './NotoSansTC-Regular.ttf';
        let __cjkReady = false;

        async function ensureCJK(doc) {
            if (__cjkReady) return;
            const res = await fetch(FONT_URL, { cache: 'no-store' });
            if (!res.ok) throw new Error(`字型載入失敗：HTTP ${res.status}`);
            const buf = await res.arrayBuffer();
            const b64 = ab2b64(buf);
            doc.addFileToVFS('NotoSansTC-Regular.ttf', b64);
            doc.addFont('NotoSansTC-Regular.ttf', 'NotoSansTC', 'normal');
            __cjkReady = true;
        }
        function ab2b64(buffer) { let binary = ''; const bytes = new Uint8Array(buffer); for (let i = 0; i < bytes.length; i += 8192) { binary += String.fromCharCode.apply(null, bytes.subarray(i, i + 8192)); } return btoa(binary); }
        function useRGB(doc, colorHex) { const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(colorHex); if (!m) return doc.setTextColor(0,0,0); doc.setTextColor(parseInt(m[1], 16), parseInt(m[2], 16), parseInt(m[3], 16)); }
        function sanitizeFileName(name) { return (name || 'report').replace(/[\\/:*?"<>|\n\r]+/g, '_').slice(0, 128); }

        /**
         * 產生並下載指定公司的 PDF 評分報告。
         * @param {number} idx - 公司在 allResultsData 陣列中的索引。
         * @param {HTMLElement} buttonElement - 觸發此函式的按鈕元素。
         */
        window.downloadPDFReport = async function(idx, buttonElement) {
            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>報告產生中...`;
            buttonElement.disabled = true;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            try {
                const r = window.allResultsData?.[idx];
                if (!r || !r.company) {
                    throw new Error(`索引 ${idx} 的結果資料不完整或不存在。`);
                }

                await ensureCJK(doc);
                doc.setFont('NotoSansTC', 'normal');

                const company = r.company;
                const COLOR_PRIMARY = '#0A1931', COLOR_SECOND = '#4A7FA7', COLOR_MUTED = '#9ca3af';
                let y = 20, W = doc.internal.pageSize.width, H = doc.internal.pageSize.height, M = 15, p = 1;

                const hdr = () => { useRGB(doc, COLOR_PRIMARY); doc.setFontSize(18); doc.text('永續報告書 AI 智能評分報告', W/2, y, {align: 'center'}); y += 10; useRGB(doc, COLOR_SECOND); doc.setFontSize(14); doc.text(`評分對象：${company}`.slice(0, 60), W/2, y, {align: 'center'}); y += 15; };
                const ftr = () => { useRGB(doc, COLOR_MUTED); doc.setFontSize(9); doc.text(`頁碼 ${p}`, W - M, H - 10, { align: 'right' }); doc.text(`報告生成時間：${new Date().toLocaleString()}`, M, H - 10); };
                const page = (need) => { if (y + need > H - 20) { ftr(); doc.addPage(); p++; y = 20; hdr(); } };

                hdr();

                useRGB(doc, COLOR_PRIMARY); doc.setFontSize(14); doc.text('AI 總評', M, y); y += 8;
                useRGB(doc, COLOR_SECOND); doc.setFontSize(10);
                const ov = doc.splitTextToSize(String(r.overview_comment || '（無）'), W - 2*M); doc.text(ov, M, y); y += ov.length * 5 + 10;

                page(20); useRGB(doc, COLOR_PRIMARY); doc.setFontSize(16); doc.text('詳細評分結果', M, y); y += 10;
                
                const blocks = r.breakdown || [];

                for (const block of blocks) {
                    page(15); useRGB(doc, COLOR_PRIMARY); doc.setFontSize(14);
                    doc.text(block.id==='report'?'永續報告書':'多元媒體應用', M, y); y += 8;
                    const sections = Array.isArray(block.sections)?block.sections:[];
                    for (const s of sections) {
                        const criteria = Array.isArray(s.criteria)?s.criteria:[];
                        for (const c of criteria) {
                            const subs = Array.isArray(c.sub_criteria)?c.sub_criteria:[];
                            for (const sub of subs) {
                                page(18); useRGB(doc, COLOR_PRIMARY); doc.setFontSize(10);
                                const title = `- ${sub?.title || '（未命名子項目）'}`;
                                const tLines = doc.splitTextToSize(title, W - 2*M - 30); doc.text(tLines, M, y);
                                const max = sub?.max_score ?? 0;
                                const sc  = sub?.score ?? null;
                                doc.text(`${sc!=null?sc.toFixed(1):'-'} / ${max}`, W - M, y, {align:'right'}); y += tLines.length*5;
                                const rat = sub?.rationale || '';
                                if (rat) { useRGB(doc, COLOR_SECOND); doc.setFontSize(9); const rLines = doc.splitTextToSize(`理由: ${rat}`.slice(0,500), W - 2*M - 5); doc.text(rLines, M+5, y); y += rLines.length*4 + 5; } else { y += 5; }
                            }
                        }
                    }
                }
                ftr();
                doc.save(`${sanitizeFileName(company)}_AI評分報告.pdf`);

            } catch (e) {
                console.error('[PDF Generation] 失敗：', e);
                window.alert('產生 PDF 時發生錯誤：' + e.message);
            } finally {
                buttonElement.innerHTML = originalButtonText;
                buttonElement.disabled = false;
            }
        };

        // --- 以下為應用程式主要邏輯 ---
        
        window.removeFile = (fileName) => {
            const decodedFileName = decodeURIComponent(fileName);
            uploadedFiles = uploadedFiles.filter(f => f.name !== decodedFileName);
            const fileItem = document.getElementById('uploaded-reports').querySelector(`[data-filename="${decodedFileName}"]`);
            if (fileItem) {
                fileItem.remove();
            }
            checkStep2Completion();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const steps = [document.getElementById('step1'), document.getElementById('step2'), document.getElementById('step3'), document.getElementById('step4')];
            const stepLines = [document.getElementById('step-line-1'), document.getElementById('step-line-2'), document.getElementById('step-line-3')];
            const stepContents = [document.getElementById('step1-content'), document.getElementById('step2-content'), document.getElementById('step3-content'), document.getElementById('step4-content')];
            
            const testConnectionBtn = document.getElementById('test-connection-btn');
            const nextStep1Btn = document.getElementById('next-step1');
            const nextStep2Btn = document.getElementById('next-step2');
            const uploadArea = document.getElementById('upload-area');
            const reportFilesInput = document.getElementById('report-files');
            const uploadedReportsContainer = document.getElementById('uploaded-reports');
            const websiteLinksContainer = document.getElementById('website-links-container');
            const analysisProgress = document.getElementById('analysis-progress');
            const restartBtn = document.getElementById('restart');
            const pdfContent = document.getElementById('pdf-content');
            const validationMsg = document.getElementById('step2-validation-msg');
            let checkStep2Completion;

            // --- ⭐ 資料正規化模組 (整合 ChatGPT 解決方案) ---
            // 移至 DOMContentLoaded 內部以解決作用域問題
            (function(){
                window.__companyFromUpload = [];
                function num(v, d=0){ const n = Number(v); return Number.isFinite(n) ? n : d; }
                function isMeaningfulBreakdown(b){ if (!Array.isArray(b) || b.length === 0) return false; for (const blk of b){ const secs = Array.isArray(blk && blk.sections) ? blk.sections : []; for (const s of secs){ const crits = Array.isArray(s && s.criteria) ? s.criteria : []; for (const c of crits){ const subs = Array.isArray(c && c.sub_criteria) ? c.sub_criteria : []; if (subs.length > 0) return true; } } } return false; }
                function coerceBlocks(rawBlocks){ const fbReport = (window.DEFAULT_RUBRIC?.report?.sections) || []; const fbMedia = (window.DEFAULT_RUBRIC?.media?.sections) || []; if (isMeaningfulBreakdown(rawBlocks)) return rawBlocks; const blocks = []; if (fbReport.length) blocks.push({ id:'report', sections: fbReport }); if (fbMedia.length) blocks.push({ id:'media', sections: fbMedia }); return blocks; }
                function computeWeightedTotals(blocks){ let reportPct = 0, mediaPct = 0; let hasReport=false, hasMedia=false; for (const blk of blocks){ const secs = Array.isArray(blk.sections) ? blk.sections : []; let sum=0, max=0; for (const s of secs){ const secScore = (typeof s.score === 'number') ? s.score : null; const secMax = num(s.max_score, 0); if (secScore != null) sum += secScore; max += secMax; } const pct = max > 0 ? (sum / max) : 0; if (blk.id === 'report'){ reportPct = pct; hasReport = true; } if (blk.id === 'media'){ mediaPct = pct; hasMedia = true; } } const reportWeighted = hasReport ? +(reportPct * 60).toFixed(1) : null; const mediaWeighted = hasMedia ? +(mediaPct * 40).toFixed(1) : null; const final = (reportWeighted!=null && mediaWeighted!=null) ? +(reportWeighted + mediaWeighted).toFixed(1) : null; return { report: reportWeighted, media: mediaWeighted, final }; }
                function pickCompany(raw, idx){ return (raw.company || raw.company_name || raw.name || raw.title || window.__companyFromUpload?.[idx] || '未命名公司'); }
                function pickOverview(raw){ return raw.overview_comment || raw.overview || raw.summary || ''; }
                window.normalizeResult = function normalizeResult(raw, idx){ const company = pickCompany(raw||{}, idx); const overview = pickOverview(raw||{}); const blocks = coerceBlocks(raw?.breakdown); let totals = raw?.totals; if (!totals || (totals.final==null && totals.report==null && totals.media==null)){ totals = computeWeightedTotals(blocks); } return { ...raw, company, overview_comment: overview, breakdown: blocks, totals }; }
                window.applyResults = function applyResults(results, fileData){ 
                    try {
                        window.__companyFromUpload = Array.isArray(fileData) ? fileData.map(d=>d.companyName) : [];
                        const norm = (Array.isArray(results) ? results : []).map((r,i)=> window.normalizeResult(r, i));
                        window.allResultsData = norm;
                        renderResults(norm); // 此處可呼叫
                        updateStepUI(4);    // 此處可呼叫
                        console.log('[applyResults] 正規化後的結果:', norm);
                    } catch(e) {
                        console.error('[applyResults] 失敗：', e);
                        window.allResultsData = Array.isArray(results) ? results : [];
                        renderResults(window.allResultsData);
                        updateStepUI(4);
                    } 
                }
                window.inspectResultForPDF = function(i){ const r = window.allResultsData?.[i]; console.log(`[inspectResultForPDF] 索引 ${i} 的資料:`, r); return r; }
            })();

            checkStep2Completion = () => {
                const hasFiles = uploadedFiles.length > 0;
                const hasLinks = Array.from(websiteLinksContainer.querySelectorAll('.website-url')).some(i => i.value.trim() !== '');
                const isComplete = hasFiles && hasLinks;
                nextStep2Btn.disabled = !isComplete;
                validationMsg.style.color = isComplete ? 'var(--primary-accent)' : '#71717a';
                validationMsg.textContent = isComplete ? '✓ 已就緒，可以開始分析' : '需至少上傳 1 份 PDF 檔案與 1 個對應的網站 URL';
            };

            const updateStepUI = (step) => {
                steps.forEach((s, index) => {
                    s.classList.remove('step-active', 'step-completed');
                    if (index < step - 1) s.classList.add('step-completed');
                    else if (index === step - 1) s.classList.add('step-active');
                });
                stepLines.forEach((line, index) => {
                    line.classList.remove('step-line-active', 'step-line-completed');
                    if (index < step - 1) line.classList.add('step-line-completed');
                    else if (index === step - 2) line.classList.add('step-line-active');
                });

                stepContents.forEach(content => content.classList.add('hidden'));
                if (stepContents[step - 1]) stepContents[step - 1].classList.remove('hidden');
            };

            const setupConnectionSection = () => {
                testConnectionBtn.addEventListener('click', async () => {
                    const testText = document.getElementById('test-text');
                    const connectionStatus = document.getElementById('connection-status');
                    const originalText = testText.textContent;
                    testText.textContent = '測試中...';
                    testConnectionBtn.disabled = true;
                    connectionStatus.classList.remove('hidden');
                    try {
                        const response = await fetch(`${BACKEND_URL}/health`);
                        if (!response.ok) throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                        const data = await response.json();
                        if (data.status === 'ok') {
                            connectionStatus.innerHTML = `<div class="p-3 bg-green-100 border border-green-200 text-green-800 rounded-md">✅ 連接成功！後端服務已準備就緒。</div>`;
                        } else { throw new Error('後端回傳狀態非 "ok"'); }
                    } catch (error) {
                        connectionStatus.innerHTML = `<div class="p-3 bg-red-100 border border-red-200 text-red-800 rounded-md">❌ 連接失敗：${error.message}。請確認後端伺服器是否已啟動。</div>`;
                    } finally {
                        testText.textContent = originalText;
                        testConnectionBtn.disabled = false;
                    }
                });
                nextStep1Btn.addEventListener('click', () => updateStepUI(2));
            };

            const setupUploadSection = () => {
                const handleFiles = (files) => {
                    for (const file of files) {
                        if (file.type !== 'application/pdf' || uploadedFiles.some(f => f.name === file.name)) continue;
                        uploadedFiles.push(file);
                        const fileItem = document.createElement('div');
                        const safeFileName = encodeURIComponent(file.name);
                        fileItem.setAttribute('data-filename', file.name);
                        fileItem.className = 'file-item bg-stone-100 p-3 rounded-lg flex items-center justify-between border border-stone-200';
                        fileItem.innerHTML = `
                            <div class="flex items-center overflow-hidden mr-2">
                                <svg class="w-6 h-6 text-red-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0011.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                <div class="truncate">
                                    <p class="font-medium text-zinc-800 truncate" title="${file.name}">${file.name}</p>
                                    <p class="text-sm text-zinc-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                </div>
                            </div>
                            <button onclick="removeFile('${safeFileName}')" class="text-slate-400 hover:text-red-500 p-2 rounded-md transition-colors flex-shrink-0" aria-label="移除檔案">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        `;
                        uploadedReportsContainer.appendChild(fileItem);
                    }
                    checkStep2Completion();
                };

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => uploadArea.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }));
                ['dragenter', 'dragover'].forEach(evt => uploadArea.addEventListener(evt, () => uploadArea.classList.add('dragover')));
                ['dragleave', 'drop'].forEach(evt => uploadArea.addEventListener(evt, () => uploadArea.classList.remove('dragover')));
                uploadArea.addEventListener('click', () => reportFilesInput.click());
                reportFilesInput.addEventListener('change', (e) => handleFiles(e.target.files));
                uploadArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
                window.addWebsiteLink = () => {
                    const div = document.createElement('div');
                    div.className = 'website-link-item flex gap-3 items-center';
                    div.innerHTML = `<input type="text" placeholder="公司名稱 (需與 PDF 檔名對應)" class="company-name w-1/3 border border-stone-300 px-3 py-2 rounded-md focus:ring-2 focus:ring-primary-blue focus:border-primary-blue" /><input type="url" placeholder="https://www.example.com" class="website-url flex-1 border border-stone-300 px-3 py-2 rounded-md focus:ring-2 focus:ring-primary-blue focus:border-primary-blue" /><button onclick="removeWebsiteLink(this)" class="text-zinc-400 hover:text-red-500 p-2 rounded-md transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
                    websiteLinksContainer.appendChild(div);
                };
                window.removeWebsiteLink = (btn) => { btn.closest('.website-link-item').remove(); checkStep2Completion(); };
                document.getElementById('step2-content').addEventListener('input', checkStep2Completion);
            };
            
            const startAnalysis = async () => {
                updateStepUI(3);
                analysisProgress.innerHTML = '';
                const updateProgress = (text, isSuccess = null) => {
                    const p = document.createElement('p');
                    const icon = isSuccess === true ? '✅' : isSuccess === false ? '❌' : '⏳';
                    p.innerHTML = `<span class="mr-2">${icon}</span> ${text}`;
                    if (isSuccess === false) p.classList.add('text-red-600', 'font-semibold');
                    analysisProgress.appendChild(p);
                };

                try {
                    const formData = new FormData();
                    const urlMap = new Map();
                    websiteLinksContainer.querySelectorAll('.website-link-item').forEach(item => {
                        const name = item.querySelector('.company-name').value.trim();
                        const url = item.querySelector('.website-url').value.trim();
                        if (name && url) urlMap.set(name, url);
                    });
                    
                    const fileData = [];
                    const unmatchedFiles = [];
                    for (const file of uploadedFiles) {
                        const baseName = file.name.replace(/\.pdf$/i, '');
                        let foundUrl = urlMap.get(baseName) || Array.from(urlMap.entries()).find(([name, url]) => baseName.includes(name) || name.includes(baseName))?.[1];
                        if (foundUrl) {
                            fileData.push({ file, companyName: baseName, websiteUrl: foundUrl });
                        } else {
                            unmatchedFiles.push(file.name);
                        }
                    }

                    if (unmatchedFiles.length > 0) {
                        updateProgress(`錯誤：以下檔案找不到對應的「公司名稱/網站」配對：`, false);
                        unmatchedFiles.forEach(name => updateProgress(`- ${name}`, false));
                        updateProgress('請返回上一步，確保「公司名稱」與 PDF 檔名（不含 .pdf）完全一致。', false);
                        return;
                    }

                    fileData.forEach(data => { formData.append('files', data.file); formData.append('company_names', data.companyName); formData.append('website_urls', data.websiteUrl); });
                    
                    updateProgress(`正在提交 ${fileData.length} 份報告書...`);
                    updateProgress('正在將檔案傳送至後端伺服器...');
                    const response = await fetch(`${BACKEND_URL}/scoring/batch`, { method: "POST", body: formData });
                    updateProgress('已收到後端初步回應！', true);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: '無法解析後端錯誤' }));
                        throw new Error(`後端錯誤 (${response.status}): ${errorData.detail}`);
                    }
                    
                    const results = await response.json();
                    updateProgress(`後端已回傳 ${results.length} 筆評分結果！`, true);
                    window.applyResults(results, fileData);

                } catch (error) {
                    let msg = error.message;
                    if (msg.includes("Load failed") || msg.includes("Failed to fetch")) msg = "與後端連接中斷。<b>請檢查 VS Code 的終端機視窗，尋找紅色的錯誤訊息。</b>";
                    updateProgress(`請求失敗: ${msg}`, false);
                    console.error(`呼叫後端 API 時出錯:`, error);
                }
            };
            
            const renderResults = (results) => {
                if (!results || results.length === 0) {
                    pdfContent.innerHTML = `<div class="card text-center p-8"><h3 class="text-2xl font-bold text-red-600">評分失敗</h3><p class="text-zinc-600 mt-2">未能從後端取得任何評分結果。請檢查後端日誌。</div>`;
                    return;
                }
                pdfContent.innerHTML = results.map((r, idx) => renderCompanyCard(r, idx)).join('');
                results.forEach((r, idx) => { try { initializeCharts(r, idx); } catch(e) { console.error(`為 ${r.company} 初始化圖表失敗:`, e); } });
            };

            const renderCompanyCard = (r, idx) => {
                const isSuccess = r.totals !== null;
                const finalScore = isSuccess ? r.totals.final : null;
                const getLevel = (score) => {
                    if (score === null) return { text: '評分失敗', textColor: 'text-red-800', bgColor: 'bg-red-100', borderColor: 'border-red-300' };
                    if (score >= 85) return { text: '優秀', textColor: 'text-green-800', bgColor: 'bg-green-100', borderColor: 'border-green-300' };
                    if (score >= 70) return { text: '良好', textColor: 'text-sky-800', bgColor: 'bg-sky-100', borderColor: 'border-sky-300' };
                    if (score >= 60) return { text: '合格', textColor: 'text-amber-800', bgColor: 'bg-amber-100', borderColor: 'border-amber-300' };
                    return { text: '待加強', textColor: 'text-red-800', bgColor: 'bg-red-100', borderColor: 'border-red-300' };
                };
                const level = getLevel(finalScore);
                let reportBreakdown = r.breakdown?.find(b => b.id === 'report');
                let mediaBreakdown = r.breakdown?.find(b => b.id === 'media');
                const renderQualitativeFeedback = (feedback, type) => {
                    const icon = type === 'strengths' ? `<svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 18.734V12.5A2.5 2.5 0 019.5 10h4.5z"></path></svg>` : `<svg class="w-6 h-6 text-amber-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`;
                    const title = type === 'strengths' ? '優點分析' : '可改善建議';
                    let contentHTML = `<p class="text-sm text-zinc-500 mt-4">(AI 未提供相關說明)</p>`;
                    if (isSuccess && feedback && Object.keys(feedback).length > 0) {
                        const feedbackContent = Object.entries(feedback).map(([category, points]) => {
                            const pointsArray = Array.isArray(points) ? points : [points];
                            if(pointsArray.length === 0) return '';
                            return `<div class="mt-3"><h5 class="font-semibold text-zinc-700">${category}</h5><ul class="pl-5 mt-1 text-zinc-600 list-disc space-y-1">${pointsArray.map(p => `<li>${p}</li>`).join('')}</ul></div>`;
                        }).join('');
                        if(feedbackContent) contentHTML = feedbackContent;
                    }
                    return `<div class="bg-stone-50 rounded-lg p-6 border border-stone-200 h-full"><div class="flex items-start"><h4 class="text-lg font-semibold text-zinc-800 flex items-center">${icon} ${title}</h4></div>${contentHTML}</div>`;
                };
                const scoreText = (score, max) => score != null ? `${score.toFixed(1)} / ${max}` : `- / ${max}`;
                const percentText = (score, max) => score != null && max > 0 ? `${(score / max * 100).toFixed(1)}%` : `-`;
                const weightedScoreText = (score, max) => score != null ? `${score.toFixed(1)}` : `-`;
                const overviewTableHTML = `
                    <table class="w-full text-sm text-left text-zinc-700">
                        <thead><tr class="border-b-2 border-stone-300"><th class="py-2 font-semibold">評分項目</th><th class="py-2 font-semibold text-center">得分</th><th class="py-2 font-semibold text-center">得分率</th></tr></thead>
                        <tbody>
                            ${[{ item: reportBreakdown, title: "永續報告書", max: 60, weightedScore: r.totals?.report }, { item: mediaBreakdown, title: "多元媒體應用", max: 40, weightedScore: r.totals?.media }].map(data => `
                                <tr class="border-b border-stone-200"><td class="py-3 font-medium text-zinc-800">${data.title}</td><td class="py-3 text-center">${scoreText(data.weightedScore, data.max)}</td><td class="py-3 text-center">${percentText(data.weightedScore, data.max)}</td></tr>
                                ${(data.item?.sections || []).map(sec => `<tr class="bg-stone-50"><td class="py-2 pl-4 text-zinc-600">- ${sec.title}</td><td class="py-2 text-center text-zinc-600">${scoreText(sec.score, sec.max_score)}</td><td class="py-2 text-center text-zinc-600">${percentText(sec.score, sec.max_score)}</td></tr>`).join('')}
                            `).join('')}
                        </tbody>
                    </table>`;
                const renderSections = (sections) => (sections || []).map(s => `
                    <div class="bg-stone-50 p-4 rounded-lg border border-stone-200 mb-4">
                        <div class="font-semibold text-zinc-800 flex justify-between items-center"><span>${s.title}</span><span>${scoreText(s.score, s.max_score)}</span></div>
                        ${(s.criteria || []).map(c => `
                            <details class="mt-3 border-t border-stone-200 pt-2" open>
                                <summary class="flex justify-between items-center py-1 font-medium text-zinc-700"><span>${c.title}</span><span class="font-semibold">${scoreText(c.score, c.max_score)}</span></summary>
                                <ul class="mt-1 pl-4 text-xs text-zinc-500 space-y-1">
                                ${(c.sub_criteria || []).map(sc => `<li><div class="flex justify-between items-center py-0.5"><span>- ${sc.title}</span><span class="font-medium">${scoreText(sc.score, sc.max_score)}</span></div>${sc.rationale ? `<div class="mt-1 pl-2 text-sky-700/90 border-l-2 border-sky-200">“${sc.rationale}”</div>` : ''}</li>`).join('')}
                                </ul>
                            </details>
                        `).join('')}
                    </div>`).join('');
                const reportDetailsHTML = reportBreakdown ? `<div><h4 class="text-xl font-semibold text-zinc-800 mb-4">永續報告書</h4>${renderSections(reportBreakdown.sections)}</div>` : '';
                const mediaDetailsHTML = mediaBreakdown ? `<div><h4 class="text-xl font-semibold text-zinc-800 mb-4">多元媒體應用</h4>${renderSections(mediaBreakdown.sections)}</div>` : '';
                return `
                <section id="company-${idx}" class="card p-6 sm:p-8 space-y-10">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200"><h3 class="text-sm font-medium text-zinc-500 mb-1">評分公司</h3><p class="text-2xl font-bold text-zinc-800 truncate" title="${r.company}">${r.company}</p></div>
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200"><h3 class="text-sm font-medium text-zinc-500 mb-1">總得分</h3><p class="text-2xl font-bold text-zinc-800">${finalScore != null ? finalScore.toFixed(1) : '-'} <span class="text-base font-normal text-zinc-500">/ 100</span></p></div>
                        <div class="${level.bgColor} ${level.textColor} p-5 rounded-lg border ${level.borderColor}"><h3 class="text-sm font-medium opacity-80 mb-1">評分等級</h3><p class="text-2xl font-bold">${level.text}</p></div>
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200"><h3 class="text-sm font-medium text-zinc-500 mb-1">分項得分 (加權後)</h3><p class="text-sm">報告書: <b class="font-semibold">${weightedScoreText(r.totals?.report, 60)}</b>/60</p><p class="text-sm mt-1">多元媒體: <b class="font-semibold">${weightedScoreText(r.totals?.media, 40)}</b>/40</p></div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-zinc-800 mb-4">AI 質化分析</h3>
                        <div class="bg-green-50 border-l-4 ${isSuccess ? 'border-green-400' : 'border-red-400'} p-4 mb-6 rounded-r-lg ${isSuccess ? 'text-green-800' : 'text-red-800'}"><b class="font-semibold">AI 總評：</b>${r.overview_comment || 'AI 分析失敗，請檢查後端日誌。'}</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">${renderQualitativeFeedback(r.strengths, 'strengths')}${renderQualitativeFeedback(r.improvements, 'improvements')}</div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-zinc-800 mb-4">評分總覽</h3>
                        <div class="card p-6"><div class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-center"><div class="lg:col-span-2 chart-container"><canvas id="overviewChart-${idx}"></canvas></div><div class="lg:col-span-3">${overviewTableHTML}</div></div></div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-zinc-800 mb-4">詳細評分</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">${reportDetailsHTML}${mediaDetailsHTML}</div>
                    </div>
                    <div class="border-t border-stone-200 pt-6 flex justify-end">
                        <button onclick="downloadPDFReport(${idx}, this)" class="btn btn-primary">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            下載此公司評分報告 (PDF)
                        </button>
                    </div>
                </section>`;
            };
            
            const initializeCharts = (r, idx) => {
                const isSuccess = r.totals !== null;
                const reportBreakdown = r.breakdown?.find(b => b.id === 'report');
                const mediaBreakdown = r.breakdown?.find(b => b.id === 'media');
                const labels = []; const scores = [];
                if (reportBreakdown && reportBreakdown.sections) { reportBreakdown.sections.forEach(sec => { labels.push(sec.title || '報告書項目'); scores.push(isSuccess ? ((sec.score ?? 0) / (sec.max_score || 1)) * 100 : 0); }); }
                if (mediaBreakdown && mediaBreakdown.sections) { mediaBreakdown.sections.forEach(sec => { labels.push(sec.title || '多元媒體項目'); scores.push(isSuccess ? ((sec.score ?? 0) / (sec.max_score || 1)) * 100 : 0); }); }
                const ctx = document.getElementById(`overviewChart-${idx}`);
                if(ctx) {
                    new Chart(ctx, {
                        type: 'bar', data: { labels: labels, datasets: [{ label: '得分率 (%)', data: scores, backgroundColor: ['#1A3D63', '#4A7FA7', '#B3CFE5', '#0A1931', '#F6FAFD'], borderRadius: 4, borderSkipped: false, }] },
                        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `得分率: ${c.raw.toFixed(1)}%` } } }, scales: { x: { beginAtZero: true, max: 100, ticks: { callback: (v) => v + '%' } }, y: { grid: { display: false } } } }
                    });
                }
            };

            setupConnectionSection();
            setupUploadSection();
            nextStep2Btn.addEventListener('click', startAnalysis);
            restartBtn.addEventListener('click', () => window.location.reload());
            updateStepUI(1);
        });
    </script>
</body>
</html>

